<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>【实战】电商数据篇（二）MySQL 实战指南</title>
    <meta name="description" content="本文是电商数据实战系列第二篇。关于数据的情况，请参考【实战】电商数据篇（一）数据初探。本篇中，我主要是为了解决以下的问题：  MySQL 建表  练习 SQL 查询：通过提问——解答的模式本文不是以解决数据模型问题为中心，更多的是对之前 SQL&amp;MySQL 学习的演练。可以根据需要跳过部分章节，不影响后续...">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="/css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2017/05/25/jdata-mysql/">
    <link rel="alternate" type="application/rss+xml" title="ZY | 数林觅风" href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?cf8506e0ef223e57ff6239944e5d46a4";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">ZY | 数林觅风</a>
        <small>Data Science & MindMap</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>【实战】电商数据篇（二）MySQL 实战指南</h1>

        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-05-25
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>ZY
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#数据科学" title="Category: 数据科学" rel="category">数据科学</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90" title="Tag: 实例分析" rel="tag">实例分析</a-->
        <a href="/tag/#实例分析" title="Tag: 实例分析" rel="tag">实例分析</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#update-log" id="markdown-toc-update-log">Update Log</a></li>
  <li><a href="#mysql-建表" id="markdown-toc-mysql-建表">MySQL 建表</a>    <ul>
      <li><a href="#用户" id="markdown-toc-用户">用户</a></li>
      <li><a href="#商品" id="markdown-toc-商品">商品</a></li>
      <li><a href="#评论" id="markdown-toc-评论">评论</a></li>
      <li><a href="#行为" id="markdown-toc-行为">行为</a></li>
    </ul>
  </li>
  <li><a href="#mysql-实操" id="markdown-toc-mysql-实操">MySQL 实操</a>    <ul>
      <li><a href="#user" id="markdown-toc-user">user</a></li>
      <li><a href="#product--comment" id="markdown-toc-product--comment">Product &amp; Comment</a></li>
      <li><a href="#actions" id="markdown-toc-actions">actions</a></li>
    </ul>
  </li>
  <li><a href="#结尾彩蛋" id="markdown-toc-结尾彩蛋">结尾彩蛋</a></li>
  <li><a href="#总结" id="markdown-toc-总结">总结</a></li>
  <li><a href="#reference" id="markdown-toc-reference">Reference</a></li>
</ul>

<p><strong>本文是电商数据实战系列第二篇。</strong>关于数据的情况，请参考<a href="https://woaielf.github.io/2017/05/20/jdata-predeal/">【实战】电商数据篇（一）数据初探</a>。</p>

<p>本篇中，我主要是为了解决以下的问题：</p>
<ul>
  <li>MySQL 建表</li>
  <li>练习 SQL 查询：通过提问——解答的模式
<strong>本文不是以解决数据模型问题为中心，更多的是对之前 SQL&amp;MySQL 学习的演练。可以根据需要跳过部分章节，不影响后续数据处理的理解。</strong>可通过<a href="https://woaielf.github.io/2017/05/04/sql/">【笔记】SQL &amp; MySQL</a> 回顾基础知识。</li>
</ul>

<p>结合使用 MySQL，一方面是「行为数据」太大，无法读入内存处理；另一方面，一直苦于没有熟练 SQL 的机会。四个表，多个字段，可以衍生出很多查询的问题。</p>

<h1 id="update-log">Update Log</h1>
<ul>
  <li>2017/05/25</li>
</ul>

<h1 id="mysql-建表">MySQL 建表</h1>

<p>首先我用 Python 分别跑了每个表每个字段的最大长度，供 MySQL 建表时参考。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE DATABASE JData;
USE JData;
</code></pre>
</div>

<h2 id="用户">用户</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE TABLE user(
    user_id INT NOT NULL,
    age TINYINT NOT NULL default -1,
    sex TINYINT NOT NULL default -1,
    user_lv_cd TINYINT NOT NULL default -1,
    user_reg_dt DATE,
    user_reg_diff INT NOT NULL default -1,
    PRIMARY KEY(user_id)
) CHARSET='utf8' ENGINE=INNODB;

LOAD DATA LOCAL INFILE "D:/02/data_ori/JData_User_New.txt" INTO TABLE user LINES TERMINATED BY '\r\n' (user_id, age, sex, user_lv_cd, user_reg_dt, user_reg_diff);
</code></pre>
</div>

<h2 id="商品">商品</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE TABLE product(
    sku_id INT NOT NULL,
    attr1 TINYINT NOT NULL,
    attr2 TINYINT NOT NULL,
    attr3 TINYINT NOT NULL,
    cate TINYINT NOT NULL,
    brand SMALLINT NOT NULL,
    PRIMARY KEY(sku_id)
) CHARSET='utf8' ENGINE=INNODB;

LOAD DATA LOCAL INFILE "D:/02/data_ori/JData_Product.txt" INTO TABLE product LINES TERMINATED BY '\r\n' (sku_id, attr1, attr2, attr3, cate, brand);
</code></pre>
</div>

<h2 id="评论">评论</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE TABLE comment(
    id INT auto_increment NOT NULL,
    dt DATE,
    sku_id INT NOT NULL,
    comment_num TINYINT NOT NULL,
    has_bad_comment TINYINT NOT NULL,
    bad_comment_rate FLOAT NOT NULL,
    PRIMARY KEY(id,sku_id)
) CHARSET='utf8' ENGINE=INNODB;

LOAD DATA LOCAL INFILE "D:/02/data_ori/JData_Comment.txt" into table comment LINES TERMINATED BY '\r\n' (dt, sku_id, comment_num, has_bad_comment, bad_comment_rate);
</code></pre>
</div>

<h2 id="行为">行为</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE TABLE actions(
    id INT auto_increment NOT NULL,
    user_id INT NOT NULL,
    sku_id INT NOT NULL,
    action_time DATETIME NOT NULL,
    model_id VARCHAR(10) NOT NULL DEFAULT -1,
    action_type TINYINT,
    cate TINYINT,
    brand SMALLINT,
    PRIMARY KEY(id)
) CHARSET='utf8' ENGINE=INNODB;

LOAD DATA LOCAL INFILE "D:/02/data_ori/JData_Action_201602.txt" INTO TABLE actions LINES TERMINATED BY '\r\n' (user_id, sku_id, action_time, model_id, action_type, cate, brand);

LOAD DATA LOCAL INFILE "D:/02/data_ori/JData_Action_201603.txt" INTO TABLE actions LINES TERMINATED BY '\r\n' (user_id, sku_id, action_time, model_id, action_type, cate, brand);

LOAD DATA LOCAL INFILE "D:/02/data_ori/JData_Action_201604.txt" INTO TABLE actions LINES TERMINATED BY '\r\n' (user_id, sku_id, action_time, model_id, action_type, cate, brand);

ALTER TABLE actions ADD INDEX user_id (user_id);
ALTER TABLE actions ADD INDEX sku_id (sku_id);
</code></pre>
</div>

<h1 id="mysql-实操">MySQL 实操</h1>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pymysql</span> <span class="kn">as</span> <span class="nn">sql</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
</code></pre>
</div>

<p>Python 连接 MySQL 并查看一下数据表的情况。</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">db</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="s">"root"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">"jdata"</span><span class="p">)</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SHOW TABLES'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>(('actions',), ('comment',), ('product',), ('test',), ('user',))
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(*) FROM actions'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((50601736,),)
</code></pre>
</div>

<p>一些基本操作过后，我们来尝试回答以下的问题（<strong>都是我即兴编造的题目，据此练习一下SQL查询，没有需求的朋友可以直接跳过这部分</strong>）：</p>

<h2 id="user">user</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># user 表的字段特征</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SHOW COLUMNS FROM user'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>(('user_id', 'int(11)', 'NO', 'PRI', None, ''),
 ('age', 'tinyint(4)', 'NO', '', '-1', ''),
 ('sex', 'tinyint(4)', 'NO', '', '-1', ''),
 ('user_lv_cd', 'tinyint(4)', 'NO', '', '-1', ''),
 ('user_reg_dt', 'date', 'YES', '', None, ''),
 ('user_reg_diff', 'int(11)', 'NO', '', '-1', ''))
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># 注册时间超过1000天的用户的等级分布</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT user_lv_cd, COUNT(*) FROM user WHERE user_reg_diff&gt;1000 GROUP BY user_lv_cd'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((1, 2663), (2, 9660), (3, 24562), (4, 32326), (5, 35985))
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># 用户等级 &amp; 性别</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT user_lv_cd, sex, COUNT(*) FROM user GROUP BY user_lv_cd, sex'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((1, 0, 258),
 (1, 1, 72),
 (1, 2, 2336),
 (2, 0, 1290),
 (2, 1, 436),
 (2, 2, 7935),
 (3, 0, 5776),
 (3, 1, 1411),
 (3, 2, 17376),
 (4, 0, 12982),
 (4, 1, 2481),
 (4, 2, 16880),
 (5, 0, 22543),
 (5, 1, 3337),
 (5, 2, 10208))
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># 统计每年的注册人数</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT YEAR(user_reg_dt), COUNT(*) FROM user GROUP BY YEAR(user_reg_dt)'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((0, 3),
 (2003, 7),
 (2004, 40),
 (2005, 58),
 (2006, 123),
 (2007, 423),
 (2008, 1538),
 (2009, 3352),
 (2010, 7148),
 (2011, 13286),
 (2012, 17528),
 (2013, 15545),
 (2014, 17199),
 (2015, 22064),
 (2016, 7007))
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># 最大最小注册时间差</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT DATEDIFF(MAX(user_reg_dt), MIN(user_reg_dt)) AS diff_time FROM user WHERE user_reg_dt != "0000-00-00"'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((4911,),)
</code></pre>
</div>

<p>结果应该和下面相同：</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT MAX(user_reg_diff) from user'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((4911,),)
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># 2016-04-01 到 2016-05-30 之间注册的用户数</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT CONCAT(sex, "-", COUNT(*)) FROM user WHERE user_reg_dt BETWEEN "2016-04-01" AND "2016-05-30" GROUP BY sex'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((b'0-36',), (b'1-19',), (b'2-339',))
</code></pre>
</div>

<h2 id="product--comment">Product &amp; Comment</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># product 表有多少不同 brand &amp; cate？</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT brand) FROM product'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT cate) FROM product'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((102,),)
((1,),)
</code></pre>
</div>

<p>观察上面可知，数据抽取的仅是一个类目（e.g.食品/电子/服饰），下面有102个品牌。</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># 看看 sku_id 在每个表中的信息条数</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT sku_id) FROM product'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"product: </span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT sku_id) FROM comment'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"comment: </span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT sku_id) FROM actions'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"actions: </span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>product: 24187
comment: 46546
actions: 28710
</code></pre>
</div>

<p>这里很清楚的能看出并不是所有sku_id都附带了商品详情的。接下来看看互相之间交集大小：</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># product vs comment</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT product.sku_id) FROM comment JOIN product WHERE comment.sku_id = product.sku_id '</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((6830,),)
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># actions vs comment</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT comment.sku_id) FROM actions JOIN comment WHERE comment.sku_id = actions.sku_id '</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((20067,),)
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># actions vs product</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT sku_id) FROM actions WHERE sku_id in (SELECT DISTINCT sku_id FROM product)'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((3938,),)
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># product vs comment vs actions</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(DISTINCT sku_id) FROM actions WHERE sku_id in (SELECT DISTINCT product.sku_id FROM product INNER JOIN comment WHERE product.sku_id = comment.sku_id)'</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>1
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((2825,),)
</code></pre>
</div>

<h2 id="actions">actions</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(*) FROM actions'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((50601736,),)
</code></pre>
</div>

<p>注意：部分查询出结果会非常慢……即使之前我对两个字段建索引了（我的电脑性能较弱，花了差不多两天的时间(⊙﹏⊙)b）。</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT COUNT(*), cate FROM actions GROUP BY cate'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((11088350, 4),
 (5731403, 5),
 (6554984, 6),
 (4365031, 7),
 (18128055, 8),
 (4005882, 9),
 (627359, 10),
 (100672, 11))
</code></pre>
</div>

<p>回想一下上面对product表的分析，cate字段只有值8……这个有点麻烦，下一篇文章再来考虑。</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># 看一下用户活动的时间区间</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT MAX(action_time), MIN(action_time) FROM actions'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((datetime.datetime(2016, 4, 15, 23, 59, 59),
  datetime.datetime(2016, 1, 31, 23, 59, 2)),)
</code></pre>
</div>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="c"># 活动类别统计</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT action_type, COUNT(*) FROM actions GROUP BY action_type'</span><span class="p">)</span>
<span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>((1, 18981373),
 (2, 575418),
 (3, 256053),
 (4, 48252),
 (5, 109896),
 (6, 30630744))
</code></pre>
</div>

<h1 id="结尾彩蛋">结尾彩蛋</h1>

<p>我们回想一下这次比赛的任务：<strong>预测2016-04-16到2016-04-20用户是否下单P中的商品，每个用户只会下单一个商品。</strong>我们不妨试着直接用MySQL来实现一下。也就是，不使用任何模型，直接拟定一些假设条件，通过SQL调出数据。</p>

<p>比如说，我就限定条件（均为“且关系”）：</p>
<ul>
  <li>2016-04-10以后</li>
  <li>用户对商品有「加购、关注」行为</li>
  <li>同时排除「删购、下单」行为</li>
  <li>取行为数最多的商品</li>
  <li>且商品包含在 P 中</li>
</ul>

<p>你也可以选择其他条件，反正我们就只是做一个初步筛选。</p>

<p>1: 浏览 2: 加购 3: 删除 4: 购买 5: 收藏 6: 点击；</p>
<div class="highlighter-rouge"><pre class="highlight"><code># 创建视图1：初步按照时间、活动类型筛选；商品包含在 P 中；过滤掉无活动的用户
CREATE VIEW check1 AS 
SELECT user_id, actions.sku_id, count(*) as counts 
FROM actions
JOIN product
WHERE (actions.sku_id = product.sku_id) AND (action_type IN (2, 5)) AND (action_time &gt; '2016-04-10')
GROUP BY user_id, actions.sku_id
HAVING counts &gt; 1;

# 创建视图2：这里我就直接选取计数最大的条目，不细究了
CREATE VIEW check2 AS
SELECT user_id, sku_id FROM check1
WHERE counts = (SELECT MAX(counts) FROM check1 AS temp WHERE temp.user_id = check1.user_id);

# 创建视图3：需要排除的用户及商品
CREATE VIEW exclude AS 
SELECT user_id, actions.sku_id 
FROM actions
JOIN product
WHERE (actions.sku_id = product.sku_id) AND (action_time &gt; '2016-04-10') AND (action_type in (3,4))
GROUP BY user_id, actions.sku_id;

# 选取数据
SELECT check2.user_id, check2.sku_id 
FROM check2 LEFT JOIN exclude
ON check2.user_id = exclude.user_id
WHERE check2.sku_id != exclude.sku_id
INTO OUTFILE 'D:/02/test1.csv'
FIELDS TERMINATED BY ','
OPTIONALLY ENCLOSED BY ''
LINES TERMINATED BY '\n';

</code></pre>
</div>

<h1 id="总结">总结</h1>

<p>本文在MySQL建表的基础上，尝试做了各种查询，包括函数的使用，视图的创建。后续在分析数据时，可以更自由的使用。</p>

<h1 id="reference">Reference</h1>
<blockquote>
  <p><a href="http://www.datafountain.cn/projects/jdata_beta/">京东JData算法大赛</a> <br />
<a href="https://github.com/foursking1/jd">foursking1/jd</a> <br />
<a href="https://github.com/ottsion/JData">ottsion/JData</a>
<a href="https://github.com/daoliker/JData">daoliker/JData</a></p>
</blockquote>

        </article>
        <hr>

        
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="http://localhost:4000/2017/05/20/jdata-predeal/">【实战】电商数据篇（一）数据初探
                            
                            </a>
                        </li>
                        
                        
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
                
                    
                
            
        
            
            
                
                    
                
            
        
            
            
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2017/05/20/jdata-predeal/">【实战】电商数据篇（一）数据初探</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2017/05/28/lib-1/">【笔记】Python（八）常用扩展库</a></p>
        
    </div>
</div>


        <!-- <h2>关于我</h2>
        本人是某医学院研究生一枚，<b>2018年7月应届毕业</b>。本硕均为医学背景，研究生阶段因学习生物信息接触到数据科学，自此爱上了编程，开始漫漫自学之路。可通过「<a href="https://woaielf.github.io/2016/09/11/data-science/">数据科学技能树</a>」了解我目前关注的领域。除此之外，我的研究生课题<b>涉及网站平台开发，故对 HTML/CSS/JQuery/PHP/MySQL 有一定了解</b>。如果您对我感兴趣，<b>愿意推荐我一份「数据分析」相关的实习/工作机会（靶标：上海/杭州）</b>，可联系我：zylovedata@163.com。非常感谢！ -->

        <!-- <h2 id="comments">Comments</h2>
        


 -->


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    <!-- <li><a href="#comments">Comments</a></li> -->
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             「数据科学思维导图笔记」 
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/woaielf" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>  
            <a href="mailto:zhaoyueelf@163.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>        
        </p>
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div style="display:none;">   
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260843486'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260843486' type='text/javascript'%3E%3C/script%3E"));</script>
</div>

    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
